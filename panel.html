<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel del Operador — Demo</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@600&display=swap" rel="stylesheet">
<style>
:root {
  --color-bg: #E8F0F5;
  --color-accent: #2F528F;
  --color-light: #FFFFFF;
  --color-gray: #F6F8FB;
  --color-text-dark: #1A1A1A;
}
* { box-sizing: border-box; margin: 0; padding: 0; }

  .link-btn{display:flex;justify-content:center;align-items:center;background:var(--color-accent);color:#fff;text-decoration:none;padding:.96rem 6rem;border-radius:999px;font-weight:700;font-size:1rem;max-width:220px;margin:0.3rem auto;box-shadow:0 2px 6px rgba(0,0,0,0.12);transition:transform .12s}
.link-btn:hover{transform:translateY(-3px);background:#1f3a66}
body {
  font-family: 'Inter', sans-serif;
  background: var(--color-bg);
  color: var(--color-text-dark);
  padding: 0.1rem;
  max-width: 500px;
  margin: auto;
}

/* NAV + SECCIONES */
header { text-align: center; margin-bottom: 2rem; }
h1 { font-family: 'Poppins', sans-serif; font-size: 1.8rem; color: var(--color-accent); }
nav { display: flex; justify-content: center; gap: 0.5rem; margin-top: 1rem; overflow-x:auto; padding-bottom:6px; }
nav button { flex: 1 0 auto; background: var(--color-accent); color: white; border: none; padding: 0.75rem; font-weight: bold; border-radius: 8px; cursor: pointer; min-width:90px; }
nav button.inactive { background: #a0b6e0; }

section { background: var(--color-light); padding: 1.5rem; border-radius: 12px; margin-top: 1rem; display: none; }
section.active { display: block; }

label { display: block; margin: 1rem 0 0.5rem; font-weight: 600; }
input, select, textarea { width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; }
input::placeholder { color: #9aa3ad; }
textarea { resize: vertical; }

button.action-btn { margin-top: 1rem; background: var(--color-accent); color: white; border: none; padding: 0.75rem; font-size: 1rem; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; }

.recordatorio-item, .pedido-item {
  background: var(--color-gray);
  padding: 0.75rem;
  border-radius: 16px;
  margin-bottom: 0.75rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  overflow: hidden;
}
.recordatorio-info, .pedido-info {
  flex: 1; padding: 0.4rem;
}
.pedido-meta { text-align: right; font-size: 0.9rem; color: #444; }

/* Pop-ups (tus existentes) */
.popUp, .confirmPop { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--color-light); padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 999; width: 92%; max-width:420px;}
.popUp button, .confirmPop button { margin-top: 0.5rem; width: 100%; }

/* parpadeo */
@keyframes parpadeo {
  0% { background-color: var(--color-light); color: var(--color-text-dark); transform: scale(1); }
  25% { background-color: #e0f0ff; color: var(--color-accent); transform: scale(1.02); }
  50% { background-color: var(--color-accent); color: #fff; transform: scale(1.05); }
  75% { background-color: #e0f0ff; color: var(--color-accent); transform: scale(1.02); }
  100% { background-color: var(--color-light); color: var(--color-text-dark); transform: scale(1); }
}

/* Tooltips */
.form-group { position: relative; }
.tooltip { display: none; position: absolute; left: 0; top: -2rem; background: var(--color-light); color: var(--color-text-dark); padding: 0.35rem 0.55rem; border-radius: 6px; font-size: 0.8rem; white-space: normal; max-width: 95%; box-shadow: 0 4px 12px rgba(0,0,0,0.12); border: 1px solid #ccc; }
.form-group:focus-within .tooltip { display: block; }

/* Teléfono */
.phone-row { display: flex; gap: 0.5rem; align-items: center; }
.phone-row select { width: 35%; min-width: 110px; }
.phone-row input { flex: 1; }

/* Mensajes y footer */
.mensaje { margin-top: 1rem; font-size: 0.95rem; padding: 0.75rem; border-radius: 8px; text-align: center; background: #FFF4CC; color: #665c00; border: 1px solid #FFE08A; }
footer { color: #888; text-align: center; padding: 0.8rem 0.5rem; font-size: 0.8rem; margin-top: 1.5rem; }

/* auth overlay (lock / stats) */
.authOverlay {
  position: fixed; inset: 0;
  display: flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(6px);
  z-index: 10000;
}
.authBox {
  background: var(--color-light);
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.25);
  padding: 1.25rem;
  width: 92%;
  max-width: 340px;
  text-align: center;
}
.authBox h2 { color: var(--color-accent); font-size: 1.2rem; margin-bottom: 0.75rem; }
.authBox input { width: 100%; padding: 0.65rem; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 0.75rem; }
.authBox .btn { width: 100%; padding: 0.65rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; background: var(--color-accent); color: #fff; }
.authBox .btn.secondary { background: #888; }
.authError { color: #e53935; font-size: 0.9rem; display: none; margin-top: 0.25rem; }

/* estadisticas iframe - aseguramos buena responsividad */
#estadisticasFrame { width:100%; min-height:60vh; border:0; border-radius:12px; background:#fff; display:block; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }

/* LIGHTBOX */
.lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.45); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; }
.lightbox.hidden { display: none; }
.lightbox-content {
  background: #fff;
  padding: 18px;
  border-radius: 12px;
  max-width: 460px;
  width: 94%;
  max-height: 78vh;
  overflow-y: auto;
  box-shadow: 0 6px 28px rgba(0,0,0,0.28);
  position: relative;
  text-align: left;
}
.close-lightbox {
  position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;
}
.lb-field { font-weight:700; margin-top: 8px; }
.lb-value { margin-top: 4px; color:#333; }

/* timeline pequeño */
.timeline{position:relative;padding-left:18px;border-left:2px solid rgba(47,82,143,0.08);margin-bottom:.5rem}
.timeline-item{position:relative;padding:8px 10px;margin-bottom:.5rem}
.timeline-item::before{content:"";position:absolute;left:-10px;top:8px;width:10px;height:10px;border-radius:50%;background:#fff;border:3px solid var(--color-accent)}
.timeline-item .state{font-weight:700}
.timeline-item .subtext{font-size:.9rem;color:#555;margin-top:.25rem}
.timeline-item .fecha{font-size:.85rem;color:#666;margin-top:.25rem}
.blink { animation: blinkAnim 0.9s step-start 0s infinite; box-shadow:0 0 0 4px rgba(47,82,143,0.06) inset; border-radius:8px; }
@keyframes blinkAnim { 50% { opacity: 0.25; transform: translateY(-1px); } }

/* confetti wrapper */
#confettiWrap{pointer-events:none;position:fixed;left:0;top:0;width:100%;height:100%;overflow:hidden;z-index:2000}

/* responsive */
@media (max-width:600px){
  header nav { gap:6px; }
  nav button { padding:0.5rem; font-size:13px; min-width:80px; }
  .pedido-item { flex-direction: column; align-items: flex-start; gap:6px; }
  .pedido-meta { text-align: left; width:100%; }
  .lightbox-content { max-width: 96%; padding: 12px; }
  #estadisticasFrame { min-height:48vh; }
}
</style>
</head>
<body>

<div id="app"><!-- wrapper para blur si hiciera falta -->

<header>
  <h1>Panel del Operador</h1>
  <nav>
    <button id="btnInicio" data-short="Inicio" aria-label="Inicio">Inicio</button>
    <button id="btnPedidos" class="inactive" data-short="Manejo" aria-label="Manejo de Pedidos">Manejo de pedidos</button>
    <button id="btnAgregar" class="inactive" data-short="Agregar" aria-label="Agregar Paquete">Agregar Paquete</button>
    <button id="btnActualizar" class="inactive" data-short="Actualizar" aria-label="Actualizar Seguimiento">Actualizar Seguimiento</button>
    <button id="btnEstadisticas" class="inactive" data-short="Estadís." aria-label="Estadísticas">Estadísticas</button>
  </nav>
</header>

<!-- Inicio: Recordatorios -->
<section id="inicio" class="active">
  <h2>Inicio</h2>
  <div id="listaRecordatorios">
    <p>No hay recordatorios por el momento.</p>
  </div>
  <button id="btnAgregarRecord" class="action-btn">Agregar Recordatorio</button>

  <!-- Pop-up Formulario -->
  <div class="popUp" id="popFormRecord" aria-hidden="true">
    <h3>Agregar Recordatorio</h3>
    <form id="formRecord">
      <label for="tituloRecord">Título del recordatorio</label>
      <input type="text" id="tituloRecord" placeholder="Ej: Llamada importante" required>
      <label for="descRecord">Descripción</label>
      <textarea id="descRecord" rows="2" placeholder="Ej: Llamar a cliente, enviar factura..." required></textarea>
      <label for="fechaRecord">Fecha límite</label>
      <input type="date" id="fechaRecord" required>
      <button type="submit" class="action-btn">Agregar</button>
      <button type="button" id="cerrarPopForm" class="action-btn" style="background:#888;">Cancelar</button>
    </form>
  </div>

  <!-- Pop Confirm -->
  <div class="confirmPop" id="popConfirm" aria-hidden="true"><p>Recordatorio agregado</p><button id="cerrarPopConfirm" class="action-btn">Cerrar</button></div>

  <div class="confirmPop" id="popEliminarConfirm" aria-hidden="true"><p>¿Desea eliminar este recordatorio?</p>
    <button id="btnConfirmEliminar" class="action-btn" style="background:#f56565;">Eliminar</button>
    <button id="btnCancelarEliminar" class="action-btn" style="background:#888;">Cancelar</button>
  </div>
</section>

<!-- MANEJO DE PEDIDOS (demo) -->
<section id="pedidos">
  <h2>Manejo de pedidos</h2>
  <div id="listaPedidos">
    <!-- llenado por JS (3 demo items) -->
  </div>

</section>

<!-- Agregar Paquete -->
<section id="agregar">
  <h2>Registrar Paquete</h2>
  <form id="formAgregar">
    <div class="form-group">
      <label for="nombre">Nombre del cliente</label>
      <div class="tooltip">Ingresa un nombre y un apellido</div>
      <input type="text" id="nombre" name="nombre" placeholder="Ej: Lester Gamez" required>
    </div>

    <div class="form-group">
      <label for="codigo">Código de seguimiento (opcional, max 10 dígitos)</label>
      <input type="text" id="codigo" name="codigo" maxlength="10" pattern="\d{0,10}" placeholder="Solo números">
    </div>

    <div class="form-group">
      <label for="telefonoDigits">Teléfono</label>
      <div class="tooltip">Selecciona (505) o (1) y luego ingresa de 8 a 10 dígitos</div>
      <div class="phone-row">
        <select id="telCode" name="telCode" required>
          <option value="(505)">(505)</option>
          <option value="(1)">(1)</option>
        </select>
        <input type="tel" id="telefonoDigits" name="telefonoDigits" placeholder="Ej: 12345678"
               inputmode="numeric" pattern="[0-9]{8,10}" title="Ingresa solo números (8 a 10 dígitos)" required>
      </div>
    </div>

    <div class="form-group">
      <label for="tipo">Tipo de envío</label>
      <select id="tipo" name="tipo" required>
        <option value="aereo">Aéreo</option>
        <option value="maritimo">Marítimo</option>
      </select>
    </div>

    <button type="submit" class="action-btn">Registrar Paquete</button>
  </form>
  <div id="mensajeAgregar" class="mensaje" style="display:none;">Esta plataforma es de prueba. Acción no disponible por el momento.</div>
</section>

<!-- Actualizar Seguimiento -->
<section id="actualizar">
  <h2>Actualizar Estado</h2>
  <form id="formActualizar">
    <div class="form-group">
      <label for="nombreSeg">Nombre del cliente</label>
      <div class="tooltip">Ingresa un nombre y un apellido</div>
      <input type="text" id="nombreSeg" name="nombreSeg" placeholder="Ej: Lester Gamez">
    </div>

    <div class="form-group">
      <label for="codigoSeg">Código de seguimiento (obligatorio, max 10 dígitos)</label>
      <input type="text" id="codigoSeg" name="codigoSeg" maxlength="10" pattern="\d{1,10}" placeholder="Solo números" required>
    </div>

    <div class="form-group">
      <label for="telefonoSegDigits">Teléfono</label>
      <div class="tooltip">Selecciona (505) o (1) y luego ingresa de 8 a 10 dígitos</div>
      <div class="phone-row">
        <select id="telCodeSeg" name="telCodeSeg">
          <option value="(505)">(505)</option>
          <option value="(1)">(1)</option>
        </select>
        <input type="tel" id="telefonoSegDigits" name="telefonoSegDigits" placeholder="Ej: 12345678"
               inputmode="numeric" pattern="[0-9]{8,10}" title="Ingresa solo números (8 a 10 dígitos)">
      </div>
    </div>

    <div class="form-group">
      <label for="estado">Estado del paquete</label>
      <select id="estado" name="estado">
        <option value="">-- Seleccione --</option>
        <option value="recibido">Recibido</option>
        <option value="en_transito">En tránsito</option>
        <option value="en_aduana">En Aduana</option>
        <option value="listo_recoger">Listo Para Recoger</option>
      </select>
    </div>

    <div class="form-group">
      <label for="pesoSeg">Peso en libras</label>
      <input type="number" id="pesoSeg" name="pesoSeg" step="0.1" min="0" placeholder="Ej: 1.0">
    </div>
    <div class="form-group">
      <label for="tarifaSeg">Tarifa en USD</label>
      <input type="number" id="tarifaSeg" name="tarifaSeg" step="0.1" min="0" placeholder="Ej: 1.1">
    </div>

    <div class="form-group">
      <label for="fechaEstado">Ingrese fecha</label>
      <input type="date" id="fechaEstado" name="fechaEstado">
    </div>

    <button type="submit" class="action-btn">Actualizar Estado</button>
  </form>
  <div id="mensajeActualizar" class="mensaje" style="display:none;">Esta plataforma es de prueba. Acción no disponible por el momento.</div>
</section>

<!-- ESTADÍSTICAS -->
<section id="estadisticas">
  <div id="estadisticas-container">
    <iframe id="estadisticasFrame" src="https://irvinforbusinesses.github.io/plantillacatalogo/estadisticas.html" title="Estadísticas" aria-hidden="true"></iframe>
  </div>
  <a class="link-btn" href="https://irvinforbusinesses.github.io/plantillacatalogo/estadisticas.html" target="_blank">Vista completa</a>
</section>

<footer>
  &copy; 2025. Irvin Prado. Ascende Superius - Seek Higher Things
</footer>
</div><!-- /#app -->

<!-- OVERLAY: LOCK INICIAL -->
<div id="lockOverlay" class="authOverlay" aria-hidden="false">
  <div class="authBox" role="dialog" aria-modal="true">
    <h2>Acceso al Panel</h2>
    <input type="password" id="lockPass" placeholder="Contraseña" aria-label="Contraseña de acceso">
    <button class="btn" id="lockSubmit">Entrar</button>
    <div class="authError" id="lockError">Contraseña incorrecta</div>
  </div>
</div>

<!-- OVERLAY: ESTADÍSTICAS -->
<div id="statsOverlay" class="authOverlay" style="display:none;" aria-hidden="true">
  <div class="authBox" role="dialog" aria-modal="true">
    <h2>Acceso a Estadísticas</h2>
    <input type="password" id="statsPass" placeholder="Contraseña" aria-label="Contraseña estadísticas">
    <button class="btn" id="statsSubmit">Acceder</button>
    <button class="btn secondary" id="statsCancel" style="margin-top:0.5rem;">Cancelar</button>
    <div class="authError" id="statsError">Contraseña incorrecta</div>
  </div>
</div>

<!-- Lightbox Recordatorio -->
<div id="lightbox-recordatorio" class="lightbox hidden" aria-hidden="true">
  <div class="lightbox-content" role="dialog" aria-modal="true">
    <button class="close-lightbox" aria-label="Cerrar">&times;</button>
    <h2>Recordatorio</h2>
    <p>Versión de prueba, datos no disponibles</p>
    <button class="btn-eliminar">Eliminar recordatorio</button>
  </div>
</div>

<!-- Lightbox Pedido (demo) -->
<div id="lightbox-pedido" class="lightbox hidden" aria-hidden="true">
  <div class="lightbox-content" role="dialog" aria-modal="true" aria-labelledby="lbPedidoTitle">
    <button class="close-lightbox" id="closePedido" aria-label="Cerrar pedido">&times;</button>
    <h2 id="lbPedidoTitle" style="text-align:center;margin-bottom:8px;">Pedido</h2>

    <div class="lb-row"><div class="lb-field">Nombre</div><div class="lb-value" id="lbNombre">-</div></div>
    <div class="lb-row"><div class="lb-field">Teléfono</div><div class="lb-value" id="lbTelefono">-</div></div>
    <div class="lb-row"><div class="lb-field">Plataforma / Agencia</div><div class="lb-value" id="lbPlataforma">-</div></div>
    <div class="lb-row"><div class="lb-field">Descripción</div><div class="lb-value" id="lbDescripcion">-</div></div>
    <div class="lb-row"><div class="lb-field">Tipo de envío</div><div class="lb-value" id="lbTipo">-</div></div>
    <div class="lb-row"><div class="lb-field">Peso aproximado (libras)</div><div class="lb-value" id="lbPeso">-</div></div>

    <div style="margin-top:10px;">
      <div class="lb-field">Vista previa del historial</div>
      <div id="lbTimeline" class="timeline" style="margin-top:6px;"></div>
    </div>

    <div style="margin-top:12px;">
      <button id="btnToggleUpdateForm" class="action-btn" style="background:#fff;color:var(--color-accent);border:1px solid #e6e9ef;">Actualizar estado</button>
    </div>

    <!-- Embedded update form (hidden by default) -->
    <div id="embeddedUpdate" style="display:none;margin-top:12px;border-top:1px solid #eef3f8;padding-top:12px;">
      <form id="embeddedUpdateForm">
        <label for="up_estado">Estado</label>
        <select id="up_estado">
          <option value="">-- Seleccione --</option>
          <option value="recibido">Recibido</option>
          <option value="en_transito">En tránsito</option>
          <option value="en_aduana">En Aduana</option>
          <option value="listo_recoger">Listo Para Recoger</option>
        </select>

        <label for="up_fecha" style="margin-top:8px;">Fecha (si selecciona estado)</label>
        <input type="date" id="up_fecha" placeholder="Selecciona fecha">

        <label for="up_peso" style="margin-top:8px;">Peso (lbs)</label>
        <input type="number" step="0.1" min="0" id="up_peso" placeholder="Ej: 1.5">

        <label for="up_tarifa" style="margin-top:8px;">Tarifa (USD)</label>
        <input type="number" step="0.1" min="0" id="up_tarifa" placeholder="Ej: 3.50">

        <div style="display:flex;gap:8px;margin-top:10px;">
          <button type="submit" class="action-btn" style="flex:1;">Actualizar estado</button>
          <button type="button" id="btnCancelEmbedded" class="action-btn" style="flex:1;background:#888;">Cancelar</button>
        </div>
      </form>
    </div>

  </div>
</div>

<!-- Confirmación visual (check circular) -->
<div id="confirmAviso" class="lightbox hidden" aria-hidden="true">
  <div class="lightbox-content" style="max-width:360px;text-align:center;">
    <div class="check-icon" aria-hidden="true">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="12" cy="12" r="10" stroke="none" fill="transparent"/>
        <path d="M9 12.5l2 2 4-4" stroke="#2F528F" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
      </svg>
    </div>
    <h3 style="color:var(--color-accent);margin-bottom:6px;">Operación simulada</h3>
    <p style="color:#444;margin-bottom:10px;">Acción realizada (demo). No se envió nada al servidor.</p>
    <button id="btnCerrarAviso" class="action-btn" style="background:var(--color-accent);">Cerrar</button>
  </div>
</div>

<!-- confetti wrapper -->
<div id="confettiWrap" aria-hidden="true"></div>

<script>
/* ----------------------- CONFIG / HELPERS ----------------------- */
const appWrapper = document.getElementById('app');

function $(id){ return document.getElementById(id); }
function hide(el){ if(!el) return; el.classList.add('hidden'); el.style.display = 'none'; el.setAttribute('aria-hidden','true'); }
function show(el){ if(!el) return; el.classList.remove('hidden'); el.style.display = 'flex'; el.removeAttribute('aria-hidden'); }

/* NAV */
const btnInicio = $('btnInicio');
const btnPedidos = $('btnPedidos');
const btnAgregar = $('btnAgregar');
const btnActualizar = $('btnActualizar');
const btnEstadisticas = $('btnEstadisticas');

const secciones = {
  inicio: $('inicio'),
  pedidos: $('pedidos'),
  agregar: $('agregar'),
  actualizar: $('actualizar'),
  estadisticas: $('estadisticas')
};

function mostrarSeccion(nombre){
  for(let s in secciones) secciones[s].classList.remove('active');
  if(secciones[nombre]) secciones[nombre].classList.add('active');
  [btnInicio,btnPedidos,btnAgregar,btnActualizar,btnEstadisticas].forEach(b => b.classList.add('inactive'));
  if(nombre==='inicio') btnInicio.classList.remove('inactive');
  if(nombre==='pedidos') btnPedidos.classList.remove('inactive');
  if(nombre==='agregar') btnAgregar.classList.remove('inactive');
  if(nombre==='actualizar') btnActualizar.classList.remove('inactive');
  if(nombre==='estadisticas') btnEstadisticas.classList.remove('inactive');
}
btnInicio.addEventListener('click',()=>mostrarSeccion('inicio'));
btnPedidos.addEventListener('click',()=>mostrarSeccion('pedidos'));
btnAgregar.addEventListener('click',()=>mostrarSeccion('agregar'));
btnActualizar.addEventListener('click',()=>mostrarSeccion('actualizar'));
btnEstadisticas.addEventListener('click',()=>{
  $('statsOverlay').style.display='flex';
  $('statsOverlay').removeAttribute('aria-hidden');
});

/* ----------------------- FECHA DEFAULT ----------------------- */
const today = new Date().toISOString().split('T')[0];
if($('fechaEstado')) $('fechaEstado').value = today;
if($('fechaRecord')) $('fechaRecord').value = today;

/* ----------------------- RECORDATORIOS (localStorage) ----------------------- */
const listDiv = $('listaRecordatorios');
const formR = $('formRecord');
const popForm = $('popFormRecord');
const popConfirm = $('popConfirm');
const popEliminarConfirm = $('popEliminarConfirm');
const btnAgregarRecord = $('btnAgregarRecord');
const cerrarPopForm = $('cerrarPopForm');
const cerrarPopConfirm = $('cerrarPopConfirm');
const btnConfirmEliminar = $('btnConfirmEliminar');
const btnCancelarEliminar = $('btnCancelarEliminar');
const fechaInput = $('fechaRecord');
let indexEliminar = null;

function cargarRecord(){
  const arr = JSON.parse(localStorage.getItem('recordatorios')||'[]');
  const hoy = new Date().toISOString().split('T')[0];
  listDiv.innerHTML='';
  const activos = arr.filter(r=>r.fecha>=hoy);
  if(!activos.length){ listDiv.innerHTML='<p>No hay recordatorios por el momento.</p>'; return; }
  activos.forEach((r,index)=>{
    const div = document.createElement('div');
    div.classList.add('recordatorio-item');
    div.dataset.index = index;
    div.innerHTML = `<div class="recordatorio-info"><strong>${escapeHtml(r.titulo)}</strong><br>${escapeHtml(r.desc)}<br><small>${escapeHtml(r.fecha)}</small></div>
                     <button class="btnEliminar" data-index="${index}">X</button>`;
    listDiv.appendChild(div);
    if(r.fecha === hoy){ div.querySelector('.recordatorio-info').style.animation="parpadeo 1.2s infinite"; }
  });
}
cargarRecord();

btnAgregarRecord.addEventListener('click', ()=> { popForm.style.display='block'; popForm.removeAttribute('aria-hidden'); });
cerrarPopForm.addEventListener('click', ()=> { popForm.style.display='none'; popForm.setAttribute('aria-hidden','true'); });

formR.addEventListener('submit', e=>{
  e.preventDefault();
  const arr = JSON.parse(localStorage.getItem('recordatorios')||'[]');
  arr.push({ titulo: $('tituloRecord').value, desc: $('descRecord').value, fecha: $('fechaRecord').value });
  localStorage.setItem('recordatorios', JSON.stringify(arr));
  formR.reset(); $('fechaRecord').value = today;
  popForm.style.display='none'; popForm.setAttribute('aria-hidden','true');
  popConfirm.style.display='block';
  popConfirm.removeAttribute('aria-hidden');
  cargarRecord();
});
cerrarPopConfirm.addEventListener('click', ()=>{ popConfirm.style.display='none'; popConfirm.setAttribute('aria-hidden','true'); });

btnCancelarEliminar.addEventListener('click', ()=>{ popEliminarConfirm.style.display='none'; popEliminarConfirm.setAttribute('aria-hidden','true'); indexEliminar=null; });
btnConfirmEliminar.addEventListener('click', ()=> {
  const arr = JSON.parse(localStorage.getItem('recordatorios')||'[]');
  if(indexEliminar != null) arr.splice(indexEliminar,1);
  localStorage.setItem('recordatorios', JSON.stringify(arr));
  cargarRecord();
  popEliminarConfirm.style.display='none'; popEliminarConfirm.setAttribute('aria-hidden','true');
  indexEliminar = null;
});

/* Delegación de clicks en recordatorios (para eliminar / ver) */
listDiv.addEventListener('click', (e)=>{
  const eliminarBtn = e.target.closest('.btnEliminar');
  if(eliminarBtn){
    indexEliminar = Number(eliminarBtn.dataset.index);
    popEliminarConfirm.style.display='block';
    popEliminarConfirm.removeAttribute('aria-hidden');
    return;
  }
  const item = e.target.closest('.recordatorio-item');
  if(item){
    const idx = Number(item.dataset.index);
    const arr = JSON.parse(localStorage.getItem('recordatorios')||'[]');
    const r = arr[idx] || {};
    // fill lightbox
    const lightbox = $('lightbox-recordatorio');
    lightbox.querySelector('h2').textContent = r.titulo || 'Recordatorio';
    lightbox.querySelector('p').innerHTML = `${escapeHtml(r.desc) || ''}<br><small>${escapeHtml(r.fecha) || ''}</small>`;
    lightbox.classList.remove('hidden');
    lightbox.removeAttribute('aria-hidden');
  }
});

/* cerrar lightbox recordatorio */
const lightboxRec = $('lightbox-recordatorio');
const closeBtnRec = lightboxRec.querySelector('.close-lightbox');
closeBtnRec.addEventListener('click', ()=>{ hide(lightboxRec); });

lightboxRec.addEventListener('click', (e)=>{ if(e.target === lightboxRec) { /* ignore overlay click: keep closed only by X */ } });

/* ----------------------- PEDIDOS DEMO ----------------------- */
const listaPedidosDiv = $('listaPedidos');

function randomDateBetween(startDaysAgo=20, endDaysAgo=1){
  const now = new Date();
  const start = new Date(now.getTime() - startDaysAgo*24*3600*1000);
  const end = new Date(now.getTime() - endDaysAgo*24*3600*1000);
  const rand = new Date(start.getTime() + Math.random()*(end.getTime()-start.getTime()));
  return rand.toISOString().split('T')[0];
}
function samplePhone(n){ return (n%2===0) ? `(505) ${Math.floor(60000000 + Math.random()*20000000)}` : `(1) ${Math.floor(2000000000 + Math.random()*7000000000)}`; }

const pedidosEjemplo = [
  {
    id: 'P-' + Math.floor(Math.random()*9000+1000),
    nombre: 'Lester Gamez',
    telefono: samplePhone(1),
    plataforma: 'Amazon Demo',
    descripcion: 'Caja con 3 perfumes y 2 accesorios',
    tipo: 'Aéreo',
    peso: '5.5',
    historial: [
      { estado: 'recibido', fecha: randomDateBetween(20,16) },
      { estado: 'en_transito', fecha: randomDateBetween(15,12) },
      { estado: 'en_aduana', fecha: randomDateBetween(11,9) },
      { estado: 'listo_recoger', fecha: randomDateBetween(8,2) }
    ]
  },
  {
    id: 'P-' + Math.floor(Math.random()*9000+1000),
    nombre: 'Ana Morales',
    telefono: samplePhone(2),
    plataforma: 'DemoStore',
    descripcion: 'Ropa y calzado - 1 paquete',
    tipo: 'Marítimo',
    peso: '2.3',
    historial: [
      { estado:'recibido', fecha: randomDateBetween(30,26) },
      { estado:'en_transito', fecha: randomDateBetween(25,20) }
    ]
  },
  {
    id: 'P-' + Math.floor(Math.random()*9000+1000),
    nombre: 'Carlos Ruiz',
    telefono: samplePhone(3),
    plataforma: 'Tienda Ejemplo',
    descripcion: 'Electrónicos pequeños (demo)',
    tipo: 'Aéreo',
    peso: '3.0',
    historial: [
      { estado:'recibido', fecha: randomDateBetween(18,14) },
      { estado:'en_transito', fecha: randomDateBetween(13,10) },
      { estado:'en_aduana', fecha: randomDateBetween(9,5) }
    ]
  }
];

// render (limit 3)
function renderPedidos(){
  listaPedidosDiv.innerHTML = '';
  pedidosEjemplo.slice(0,3).forEach((p, idx)=>{
    const firstDate = (p.historial && p.historial.length>0) ? p.historial[0].fecha : '-';
    const div = document.createElement('div');
    div.className = 'pedido-item';
    div.dataset.index = idx;
    div.innerHTML = `
      <div class="pedido-info"><strong>${escapeHtml(p.nombre)}</strong><div class="small-muted">Ingresado: ${escapeHtml(firstDate)}<br>${escapeHtml(p.plataforma)}</div></div>
      <div class="pedido-meta">${escapeHtml(p.tipo)}</div>
    `;
    listaPedidosDiv.appendChild(div);
  });
}
renderPedidos();

/* ----------------------- Lightbox Pedido (only X closes overlay) ----------------------- */
const lbPedido = $('lightbox-pedido');
const lbClose = $('closePedido');
const lbNombre = $('lbNombre');
const lbTelefono = $('lbTelefono');
const lbPlataforma = $('lbPlataforma');
const lbDescripcion = $('lbDescripcion');
const lbTipo = $('lbTipo');
const lbPeso = $('lbPeso');
const lbTimeline = $('lbTimeline');

const confirmAviso = $('confirmAviso');
const btnCerrarAviso = $('btnCerrarAviso');

let pedidoSeleccionadoIndex = null;

listaPedidosDiv.addEventListener('click', (e)=>{
  const item = e.target.closest('.pedido-item');
  if(!item) return;
  pedidoSeleccionadoIndex = Number(item.dataset.index);
  const p = pedidosEjemplo[pedidoSeleccionadoIndex];
  // fill details
  lbNombre.textContent = p.nombre;
  lbTelefono.textContent = p.telefono;
  lbPlataforma.textContent = p.plataforma;
  lbDescripcion.textContent = p.descripcion;
  lbTipo.textContent = p.tipo;
  lbPeso.textContent = `${p.peso} lb`;
  // timeline
  renderTimeline(p.historial || [], lbTimeline);
  // show lightbox (only via X to close)
  lbPedido.classList.remove('hidden');
  lbPedido.style.display = 'flex';
  lbPedido.removeAttribute('aria-hidden');
  // ensure focus on close btn
  setTimeout(()=> { $('closePedido').focus(); }, 60);
});

// Prevent closing lightbox by clicking overlay — only the close button closes it
lbPedido.addEventListener('click', (e)=>{
  // do nothing on overlay clicks to force X to close
  // intentionally left blank
});
lbClose.addEventListener('click', ()=>{ hide(lbPedido); });

function renderTimeline(hist, container){
  container.innerHTML = '';
  if(!hist || hist.length===0){ container.innerHTML = '<div class="small-muted">No hay eventos en el historial.</div>'; return; }
  hist.forEach((h)=>{
    const div = document.createElement('div');
    div.className = 'timeline-item';
    div.innerHTML = `<div class="state">${mapStateLabel(h.estado)}</div>
                     <div class="subtext">${mapStateSubtext(h.estado)}</div>
                     <div class="fecha">${h.fecha ? 'El ' + formatDate(h.fecha) : ''}</div>`;
    if(String(h.estado).toLowerCase()==='listo_recoger') div.classList.add('blink');
    container.appendChild(div);
  });
  // trigger confetti if last state is listo_recoger
  const last = hist[hist.length-1];
  if(last && String(last.estado).toLowerCase()==='listo_recoger') triggerConfetti();
}

/* ----------------------- Embedded Update Form inside Lightbox ----------------------- */
const btnToggleUpdateForm = $('btnToggleUpdateForm');
const embeddedUpdate = $('embeddedUpdate');
const embeddedUpdateForm = $('embeddedUpdateForm');
const btnCancelEmbedded = $('btnCancelEmbedded');

btnToggleUpdateForm.addEventListener('click', ()=>{
  if(embeddedUpdate.style.display === 'none' || embeddedUpdate.style.display === ''){
    embeddedUpdate.style.display = 'block';
    embeddedUpdate.removeAttribute('aria-hidden');
    // prefill with current selected pedido values if any
    const p = pedidosEjemplo[pedidoSeleccionadoIndex];
    if(p){
      $('up_peso').value = p.peso || '';
      $('up_tarifa').value = ''; // demo: unknown
      $('up_estado').value = '';
      $('up_fecha').value = '';
      // scroll form into view
      setTimeout(()=> embeddedUpdate.scrollIntoView({behavior:'smooth', block:'center'}), 120);
    }
  } else {
    embeddedUpdate.style.display = 'none';
    embeddedUpdate.setAttribute('aria-hidden','true');
  }
});
btnCancelEmbedded.addEventListener('click', ()=>{
  embeddedUpdate.style.display = 'none';
  embeddedUpdate.setAttribute('aria-hidden','true');
});

/* Handle embedded update form submission (demo: validate, update local data, show confirm) */
embeddedUpdateForm.addEventListener('submit', function(e){
  e.preventDefault();
  const estado = $('up_estado').value || null;
  const fecha = $('up_fecha').value || null;
  const peso = $('up_peso').value ? Number($('up_peso').value) : null;
  const tarifa = $('up_tarifa').value ? Number($('up_tarifa').value) : null;

  // validation: at least one of estado/peso/tarifa
  if(!estado && peso === null && tarifa === null){
    alert('Ingresa al menos un campo para actualizar (estado, peso o tarifa).');
    return;
  }
  // if estado provided, fecha is required
  if(estado && !fecha){
    alert('Si ingresa un estado, la fecha es obligatoria.');
    return;
  }

  // simulate processing
  showProcessingSimulation();

  // update local demo data (in-memory)
  const p = pedidosEjemplo[pedidoSeleccionadoIndex];
  if(p){
    if(peso !== null) p.peso = String(peso);
    if(tarifa !== null) p.tarifa = String(tarifa);
    if(estado){
      p.historial = p.historial || [];
      // push to historial as next slot (limit 4)
      p.historial.push({ estado: estado, fecha: fecha });
      if(p.historial.length > 4) p.historial = p.historial.slice(-4);
    }
  }

  // after simulated processing, update UI
  setTimeout(()=>{
    hideProcessingSimulation();
    embeddedUpdate.style.display = 'none';
    renderPedidos(); // refresh list preview
    // if lightbox still open, refresh its displayed details and timeline
    if(!lbPedido.classList.contains('hidden')){
      const pp = pedidosEjemplo[pedidoSeleccionadoIndex];
      lbPeso.textContent = `${pp.peso || '-'} lb`;
      renderTimeline(pp.historial || [], lbTimeline);
    }
    // show confirmation
    confirmAviso.classList.remove('hidden');
    confirmAviso.style.display = 'flex';
    confirmAviso.removeAttribute('aria-hidden');
  }, 900);
});

/* Processing simulation UI (simple) */
function showProcessingSimulation(){
  confirmAviso.classList.remove('hidden');
  confirmAviso.style.display='flex';
  confirmAviso.removeAttribute('aria-hidden');
  confirmAviso.querySelector('h3').textContent = 'Actualizando (simulado)';
  confirmAviso.querySelector('p').textContent = 'Simulando actualización...';
  $('btnCerrarAviso').style.display='none';
}
function hideProcessingSimulation(){
  confirmAviso.querySelector('h3').textContent = 'Operación simulada';
  confirmAviso.querySelector('p').textContent = 'Acción realizada (demo). No se envió nada al servidor.';
  $('btnCerrarAviso').style.display = 'block';
}

/* Close confirmAviso when click on close */
$('btnCerrarAviso').addEventListener('click', ()=> hide(confirmAviso));

/* ----------------------- CONFETTI (desktop/mobile split) ----------------------- */
let confettiTimeout = null;
function triggerConfettiDesktop(){
  const wrap = document.getElementById('confettiWrap');
  if(!wrap) return;
  const N = 300;
  const colors = ['#1f3a66','#2F528F','#79A7E4'];
  wrap.innerHTML = '';
  for(let i=0;i<N;i++){
    const el = document.createElement('div');
    const size = Math.floor(Math.random()*8)+6;
    el.style.position='absolute';
    el.style.left = Math.random()*100 + '%';
    el.style.top = (-50 + Math.random()*-50) + 'px';
    el.style.width = size + 'px';
    el.style.height = (size*0.6) + 'px';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.opacity = String(0.7 + Math.random()*0.3);
    el.style.borderRadius = '2px';
    el.style.zIndex = 2500;
    const destX = (Math.random()*500 - 250);
    const destY = window.innerHeight + 100;
    const duration = 4 + Math.random()*4;
    el.style.transition = `transform ${duration}s ease-out, top ${duration}s linear, opacity ${duration}s linear`;
    wrap.appendChild(el);
    requestAnimationFrame(()=> {
      el.style.top = destY + 'px';
      el.style.transform = `translateX(${destX}px) rotate(${Math.random()*360}deg)`;
      el.style.opacity = '0';
    });
  }
  if(confettiTimeout) clearTimeout(confettiTimeout);
  confettiTimeout = setTimeout(()=> wrap.innerHTML = '', 9000);
}
function triggerConfettiMobile(){
  const wrap = document.getElementById('confettiWrap');
  if(!wrap) return;
  const N = 120;
  const colors = ['#1f3a66','#2F528F','#79A7E4'];
  wrap.innerHTML = '';
  for(let i=0;i<N;i++){
    const el = document.createElement('div');
    const size = Math.floor(Math.random()*8)+6;
    el.style.position='absolute';
    el.style.left = Math.random()*100 + '%';
    el.style.top = (-50 + Math.random()*-50) + 'px';
    el.style.width = size + 'px';
    el.style.height = (size*0.6) + 'px';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.opacity = String(0.7 + Math.random()*0.3);
    el.style.borderRadius = '2px';
    el.style.zIndex = 2500;
    const destX = (Math.random()*500 - 250);
    const destY = window.innerHeight + 100;
    const duration = 4 + Math.random()*4;
    el.style.transition = `transform ${duration}s ease-out, top ${duration}s linear, opacity ${duration}s linear`;
    wrap.appendChild(el);
    requestAnimationFrame(()=> {
      el.style.top = destY + 'px';
      el.style.transform = `translateX(${destX}px) rotate(${Math.random()*360}deg)`;
      el.style.opacity = '0';
    });
  }
  if(confettiTimeout) clearTimeout(confettiTimeout);
  confettiTimeout = setTimeout(()=> wrap.innerHTML = '', 9000);
}
function triggerConfetti(){
  if(window.innerWidth <= 420) triggerConfettiMobile(); else triggerConfettiDesktop();
}

/* ----------------------- UTIL / HELPERS ----------------------- */
function escapeHtml(str){ if(str===null||str===undefined) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function formatDate(d){ try{ const dt = new Date(d); if(isNaN(dt)) return d; return dt.toLocaleDateString('es-ES'); }catch(e){return d;} }
function mapStateLabel(raw){ if(!raw) return 'Estado desconocido'; const r = String(raw).toLowerCase(); switch(r){ case 'recibido': return 'Recibido'; case 'en_transito': return 'En tránsito'; case 'en_aduana': return 'En Aduana'; case 'listo_recoger': return 'Listo Para Recoger'; default: return raw; } }
function mapStateSubtext(raw){ if(!raw) return ''; const r = String(raw).toLowerCase(); switch(r){ case 'recibido': return 'Paquete recibido en origen'; case 'en_transito': return 'En tránsito hacia destino'; case 'en_aduana': return 'En proceso aduanal'; case 'listo_recoger': return 'Listo para retiro en sucursal'; default: return ''; } }

/* ----------------------- FORM AGREGAR / ACTUALIZAR (demo) ----------------------- */
$('formAgregar').addEventListener('submit', function(e){
  e.preventDefault();
  const nombre = $('nombre').value.trim();
  const telCode = $('telCode').value;
  const telefonoDigits = $('telefonoDigits').value.trim();
  const telefono = telefonoDigits ? `${telCode} ${telefonoDigits}` : '';
  const tipo = $('tipo').value;
  const codigo = $('codigo').value.trim() || null;
  if(!nombre || !telefonoDigits){ alert('Nombre y teléfono son obligatorios.'); return; }
  const newP = { id: 'P-' + Math.floor(Math.random()*9000+1000), nombre, telefono, plataforma:'(Demo) Registro manual', descripcion:'Agregado desde demo', tipo, peso: '-', historial: [{estado:'recibido', fecha: today}] };
  pedidosEjemplo.unshift(newP);
  renderPedidos();
  this.reset();
  $('mensajeAgregar').style.display='block';
  setTimeout(()=> $('mensajeAgregar').style.display='none', 2500);
});

/* Demo actualizar (section) - not wired to real backend, shows message */
$('formActualizar').addEventListener('submit', function(e){
  e.preventDefault();
  $('mensajeActualizar').style.display='block';
  setTimeout(()=> $('mensajeActualizar').style.display='none', 2500);
  this.reset();
  $('fechaEstado').value = today;
});

/* ----------------------- CONTRASEÑAS / STATS ----------------------- */
const PASS_LOCK  = "12345678";
const PASS_STATS = "12345678";

const lockOverlay = $('lockOverlay');
const lockPass = $('lockPass');
const lockSubmit = $('lockSubmit');
const lockError = $('lockError');

const statsOverlay = $('statsOverlay');
const statsPass = $('statsPass');
const statsSubmit = $('statsSubmit');
const statsCancel = $('statsCancel');
const statsError = $('statsError');
const statsFrame = $('estadisticasFrame');

appWrapper.style.filter = 'blur(6px)';

function tryUnlock(){
  if(lockPass.value === PASS_LOCK){
    lockError.style.display = 'none';
    lockOverlay.style.display = 'none';
    lockOverlay.setAttribute('aria-hidden','true');
    appWrapper.style.filter = 'none';
    lockPass.value = '';
    // after unlock show initial data
    cargarRecord();
    renderPedidos();
  } else {
    lockError.style.display = 'block';
  }
}
lockSubmit.addEventListener('click', tryUnlock);
lockPass.addEventListener('keydown', (e)=>{ if(e.key==='Enter') tryUnlock(); });

function openStats(){ statsOverlay.style.display='flex'; statsOverlay.removeAttribute('aria-hidden'); statsPass.value=''; statsPass.focus(); }
function closeStats(){ statsOverlay.style.display='none'; statsOverlay.setAttribute('aria-hidden','true'); }
function loadStatsIfAuthorized(){
  if(statsPass.value === PASS_STATS){
    statsError.style.display = 'none';
    closeStats();
    if(statsFrame.src === '') statsFrame.src = 'https://irvinforbusinesses.github.io/plantillacatalogo/estadisticas.html';
    mostrarSeccion('estadisticas');
    statsPass.value = '';
  } else {
    statsError.style.display = 'block';
  }
}
statsSubmit.addEventListener('click', loadStatsIfAuthorized);
statsPass.addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadStatsIfAuthorized(); });
statsCancel.addEventListener('click', closeStats);

/* ----------------------- LIGHTBOX RECORDATORIO CLOSES ----------------------- */
document.querySelectorAll('.close-lightbox').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    const parent = btn.closest('.lightbox');
    if(parent) hide(parent);
  });
});

/* ----------------------- UTIL: escape click outside for recordatorio only (kept) ----------------------- */
document.querySelectorAll('.lightbox').forEach(lb=>{
  lb.addEventListener('click', (e)=>{
    if(lb === $('lightbox-recordatorio')){
      if(e.target === lb) hide(lb);
    }
  });
});

/* ----------------------- INITIAL STATE ----------------------- */
mostrarSeccion('inicio');
hide($('popFormRecord'));
hide($('popConfirm'));
hide($('popEliminarConfirm'));
hide($('lightbox-pedido'));
hide($('confirmAviso'));
hide($('lightbox-recordatorio'));
hide($('confirmAviso')); // ensure hidden

/* ----------------------- small misc ----------------------- */
function mapStateLabel(raw){ if(!raw) return 'Estado desconocido'; const r = String(raw).toLowerCase(); switch(r){ case 'recibido': return 'Recibido'; case 'en_transito': return 'En tránsito'; case 'en_aduana': return 'En Aduana'; case 'listo_recoger': return 'Listo Para Recoger'; default: return raw; } }
function mapStateSubtext(raw){ if(!raw) return ''; const r = String(raw).toLowerCase(); switch(r){ case 'recibido': return 'Paquete recibido en origen'; case 'en_transito': return 'En tránsito hacia destino'; case 'en_aduana': return 'En proceso aduanal'; case 'listo_recoger': return 'Listo para retiro en sucursal'; default: return ''; } }
</script>
</body>
</html>
