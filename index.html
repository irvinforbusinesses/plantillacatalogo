<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Seguimiento y Cotización — Demo</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@600&display=swap" rel="stylesheet">
<style>
:root{
  --color-bg:#E8F0F5;
  --color-accent:#2F528F;
  --text:#1A1A1A;
  --solicitar-highlight: #2832C2;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:"Inter",sans-serif;
  background:var(--color-bg);
  color:var(--text);
  padding:1rem;
  max-width:500px;
  margin:auto;
  padding-bottom:80px;
}
footer { color: #888; text-align: center; padding: 0.8rem 0.5rem; font-size: 0.8rem; margin-top: 1.5rem; }

header{text-align:center;margin-bottom:1.5rem}
h1{font-family:'Poppins',sans-serif;font-size:1.8rem;color:var(--color-accent)}
nav{display:flex;justify-content:center;gap:.5rem;margin-top:1rem}
nav button{flex:1;background:var(--color-accent);color:#fff;border:none;padding:.75rem;font-weight:700;border-radius:8px;cursor:pointer; transition:transform .12s}
nav button.inactive{background:#a0b6e0}
/* ocultar el boton solicitar del nav */
nav button#btnSolicitar{ display:none; }

/* hacer que "Cotizar" tenga el estilo destacado (mismo look que solicit-ar en antiguas versiones) */
nav button#btnCotizar { background: var(--solicitar-highlight); box-shadow: 0 6px 14px rgba(31,58,102,0.16); }

nav button:hover{ transform: translateY(-2px); }

/* sections */
section{
  background:#FFFFFF;
  padding:1.5rem;
  border-radius:12px;
  margin-top:1rem;
  display:none;
  opacity:0;
  transform:translateY(12px);
  animation: fadeIn 0.7s forwards;
  box-shadow:0 6px 14px rgba(0,0,0,0.08);
}
section.active{display:block}
@keyframes fadeIn{to{opacity:1;transform:translateY(0)}}

/* Inicio linktree - small tweaks */
#inicio{text-align:center;padding:2rem 1rem}
#inicio img{width:100px;height:100px;border-radius:50%;display:block;margin:0 auto 1rem;object-fit:cover;box-shadow:0 6px 18px rgba(47,82,143,0.18)}
.linktree-buttons{display:flex;flex-direction:column;gap:1rem}
.link-btn{display:flex;justify-content:center;align-items:center;background:var(--color-accent);color:#fff;text-decoration:none;padding:.95rem 6rem;border-radius:999px;font-weight:700;font-size:1rem;max-width:220px;margin:0.3rem auto;box-shadow:0 2px 6px rgba(0,0,0,0.12);transition:transform .12s}
.link-btn:hover{transform:translateY(-3px);background:#1f3a66}

/* Form basics */
label{display:block;margin:1rem 0 .5rem;font-weight:600}
select,input,textarea{width:100%;padding:.75rem;border-radius:8px;border:1px solid #ccc;font-size:1rem}
textarea{min-height:90px;resize:vertical}
button.calc-btn{margin-top:1rem;background:var(--color-accent);color:white;border:none;padding:.75rem;font-size:1rem;border-radius:8px;width:100%;font-weight:bold;cursor:pointer}
.resultado{margin-top:1rem;font-size:1.05rem;font-weight:600}

/* Seguimiento form layout */
.row{display:flex;gap:.5rem}
.col{flex:1}

/* small flag+phone */
.phone-row{display:flex;gap:.5rem}
.phone-row select{width:35%;padding:.6rem;border-radius:8px}
.phone-row input{flex:1}

/* resultado package box */
.package-box{margin-top:1rem;padding:1rem;border-radius:10px;background:#fbfcfe;border:1px solid #eef3f8}
.package-title{font-weight:700;margin-bottom:.5rem;color:var(--color-accent)}
.details-row{display:flex;justify-content:space-between;gap:.5rem;margin-top:.4rem;font-size:.95rem}
.details-row div{flex:1;text-align:left}

/* results list (cards) */
.results-list{display:flex;flex-direction:column;gap:0.75rem;margin-top:0.5rem}
.result-card{display:flex;justify-content:space-between;align-items:center;padding:0.75rem;border-radius:12px;background:#fff;border:1px solid #e9f0fb;cursor:pointer;box-shadow:0 2px 8px rgba(47,82,143,0.04)}
.result-card:hover{transform:translateY(-3px)}
.result-card .left{display:flex;flex-direction:column;gap:4px}
.result-card .meta{font-size:0.95rem;color:#444}
.result-card .right{font-weight:700;color:var(--color-accent);font-size:0.95rem}

/* timeline */
.timeline{position:relative;padding-left:24px;border-left:2px solid rgba(47,82,143,0.08);margin-bottom:.5rem}
.timeline-item{position:relative;padding:8px 12px;margin-bottom:.5rem}
.timeline-item::before{content:"";position:absolute;left:-11px;top:8px;width:12px;height:12px;border-radius:50%;background:#fff;border:3px solid var(--color-accent)}
.timeline-item .state{font-weight:700}
.timeline-item .subtext{font-size:.9rem;color:#555;margin-top:.25rem}
.timeline-item .fecha{font-size:.85rem;color:#666;margin-top:.25rem}

/* blinking mini section for listo_recoger */
.blink {
  animation: blinkAnim 0.9s step-start 0s infinite;
  box-shadow:0 0 0 4px rgba(47,82,143,0.06) inset;
  border-radius:8px;
}
@keyframes blinkAnim {
  50% { opacity: 0.25; transform: translateY(-1px); }
}

/* confetti container */
#confettiWrap{pointer-events:none;position:fixed;left:0;top:0;width:100%;height:100%;overflow:hidden;z-index:2000}

/* small utility */
.small-muted{font-size:.9rem;color:#666;margin-top:.25rem}
.center{text-align:center}

/* receipt / mini result for cotizar (centered) */
.cotiza-box{margin-top:1rem;padding:14px;border-radius:10px;background:#fff;border:1px solid #eef3f8;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;box-shadow:0 6px 18px rgba(47,82,143,0.06)}
.cotiza-price{font-weight:800;font-size:1.3rem;color:var(--color-accent)}
.cotiza-sub{font-size:0.95rem;color:#444}

/* Modal */
.modal-backdrop{
  position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:3000;
  opacity:0;pointer-events:none;transition:opacity .28s ease;
}
.modal-backdrop.show{opacity:1;pointer-events:auto}
.modal{
  width:86%;max-width:520px;background:#fff;border-radius:12px;padding:1.25rem;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.18);transform:translateY(8px);transition:transform .28s ease, opacity .28s ease; opacity:0;
}
.modal-backdrop.show .modal{ transform: translateY(0); opacity:1; }

/* package detail modal has scroll area */
.package-modal .modal{max-width:520px;max-height:84vh;overflow-y:auto;text-align:left}
.package-modal .close-x{position:absolute;right:14px;top:10px;background:#fff;border:1px solid #e6e9ef;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
.package-modal h3{color:var(--color-accent);margin-top:0}

/* small CTA (same look as linktree buttons) */
#floatCTA .link-btn { max-width:220px; padding:.6rem 1rem; font-size:0.95rem; display:inline-block; }

/* responsive tweaks */
@media (max-width:420px){ .link-btn{max-width:100%} .phone-row select{width:40%} .modal{width:92%} }
</style>
</head>
<body>

<header>
  <h1>Nica Expressway</h1>
  <nav>
    <button id="btnInicio">Inicio</button>
    <button id="btnCotizar" class="inactive">Cotizar</button>
    <button id="btnSolicitar">Solicitar</button>
    <button id="btnSeguimiento" class="inactive">Seguimiento</button>
  </nav>
</header>

<!-- INICIO -->
<section id="inicio" class="active">
  <img id="logoMain" src="https://github.com/Irvyandl/VirtualAssistance/blob/main/assets/visuals/logo.jpg?raw=true" alt="Logo Nica Expressway">
  <p style="margin-bottom:1.25rem;">Conéctate con nosotros en nuestras redes y mantente al día con tus envíos</p>
  <div class="linktree-buttons">
    <a class="link-btn" href="#" onclick="alert('Demo: enlace falso para demo.');return false;">Instagram</a>
    <a class="link-btn" href="#" onclick="alert('Demo: enlace falso para demo.');return false;">Facebook</a>
    <a class="link-btn" href="#" onclick="alert('Demo: enlace falso para demo.');return false;">WhatsApp</a>
  </div>
</section>

<!-- COTIZAR -->
<section id="cotizar">
  <h2>Calculadora de Envío</h2>
  <label for="tipoEnvioCotizar">Tipo de envío:</label>
  <select id="tipoEnvioCotizar">
    <option value="aereo">Aéreo</option>
    <option value="maritimo">Marítimo</option>
  </select>

  <label for="pesoCotizar">Peso aproximado (libras):</label>
  <input type="number" id="pesoCotizar" placeholder="Ej: 5">

  <button class="calc-btn" onclick="calcularCotizar()">Calcular</button>

  <!-- mini contenedor centrado para resultados -->
  <div id="resultadoCotizar" class="cotiza-box" style="display:none;">
    <div class="cotiza-price" id="cotizaPrice">-</div>
    <div class="cotiza-sub" id="cotizaDays">-</div>
  </div>

  <!-- boton flotante de "realiza tu pedido ahora" (demo: aparece a 3s) -->
  <div id="floatCTA" style="display:none;text-align:center;margin-top:12px;">
    <a id="ctaWhats" class="link-btn" href="#" onclick="alert('Demo: abrir WhatsApp (falso)');return false;" style="animation:float 3s ease-in-out infinite;">
      Realiza tu pedido ahora
    </a>
  </div>
  <style>
    @keyframes float { 0%{transform:translateY(0)} 50%{transform:translateY(-6px)} 100%{transform:translateY(0)} }
  </style>
</section>

<!-- SOLICITAR (la sección existe pero el nav ya no tiene acceso visible) -->
<section id="solicitar">
  <h2>Solicita tu pedido</h2>

  <label for="nombreSolicitar">Nombre</label>
  <input type="text" id="nombreSolicitar" placeholder="Ej: Lester Gamez" required>

  <label for="telefonoSolicitar">Teléfono</label>
  <div class="phone-row">
    <select id="telCodeSolicitar" aria-label="Código país">
      <option value="+505">+505</option>
      <option value="+1">+1</option>
    </select>
    <input type="tel" id="telefonoSolicitar" placeholder="Ej: 12345678" inputmode="numeric" pattern="[0-9]{8,10}" minlength="8" maxlength="10" required>
  </div>

  <label for="plataformaSolicitar">Plataforma/Agencia</label>
  <input type="text" id="plataformaSolicitar" placeholder="Ej: Shein" required>

  <label for="descripcionSolicitar">Descripción (opcional)</label>
  <textarea id="descripcionSolicitar" placeholder="Ropa, perfumes, etc (opcional)"></textarea>

  <label for="tipoEnvioSolicitar">Tipo de envío:</label>
  <select id="tipoEnvioSolicitar" required>
    <option value="">-- Selecciona --</option>
    <option value="aereo">Aéreo</option>
    <option value="maritimo">Marítimo</option>
  </select>

  <label for="pesoSolicitar">Peso aproximado (libras):</label>
  <input type="number" id="pesoSolicitar" placeholder="Ej: 5" min="0.1" step="0.1" required>

  <button id="btnCalcularSolicitar" class="calc-btn" type="button">Solicitar</button>

  <div id="reciboSolicitar" style="display:none;margin-top:1rem;">
    <div class="hr-divider"></div>
    <div class="receipt-line"><div>Precio por libra de envío</div><div id="precioPorLb">$0.00</div></div>
    <div class="receipt-line"><div>Libras totales</div><div id="librasTotales">0</div></div>
    <div class="receipt-line"><div>Total</div><div id="totalSolicitar">$0.00</div></div>
    <div style="margin-top:0.75rem;">
      <button id="btnConfirmarSolicitud" class="calc-btn" style="display:none;background:#2F528F">Confirmar solicitud</button>
    </div>
  </div>
</section>
  
<!-- SEGUIMIENTO -->
<section id="seguimiento">
  <h2>Seguimiento de Pedido</h2>

  <!-- Form: codigo OR nombre OR telefono -->
  <label for="codigo">Código de seguimiento</label>
  <input type="text" id="codigo" placeholder="Ej: ABC123">

  <label for="nombreBuscar">Nombre del cliente</label>
  <input type="text" id="nombreBuscar" placeholder="Ej: Lester Gamez">

  <label for="telefonoBuscar">Teléfono (8-10 dígitos)</label>
  <div class="phone-row" style="margin-bottom:0.5rem;">
    <select id="telCodeBuscar">
      <option value="+505">+505</option>
      <option value="+1">+1</option>
      <option value="+52">+52</option>
    </select>
    <input type="tel" id="telefonoBuscar" placeholder="Ej: 12345678" inputmode="numeric" pattern="[0-9]{8,10}">
  </div>

  <div class="row" style="gap:.6rem;margin-top:.6rem;">
    <div class="col"><button id="btnBuscar" class="calc-btn">Buscar</button></div>
    <div class="col"><button id="btnLimpiar" class="calc-btn" style="background:#888;">Limpiar</button></div>
  </div>

  <!-- Loader / overlay pequeño -->
  <div id="searchOverlay" style="display:none;margin-top:1rem;padding:.9rem;border-radius:8px;background:#f3f7fb;text-align:center;">
    <strong>Buscando tu paquete, espera...</strong>
  </div>

  <!-- Results list (max 3 cards) -->
  <div id="resultsList" class="results-list" style="display:none"></div>

  <!-- single package detail area (kept for backwards compatibility but hidden; details use modal) -->
  <div id="resultContainer" class="package-box" style="display:none;">
    <div id="timeline" class="timeline"></div>
    <div id="packageDetails" class="details-row" style="margin-top:1rem">
      <div>
        <div class="small-muted">Tipo de envío</div>
        <div id="detalleTipo">-</div>
      </div>
      <div>
        <div class="small-muted">Peso (lbs)</div>
        <div id="detallePeso">-</div>
      </div>
      <div>
        <div class="small-muted">Tarifa / lb (USD)</div>
        <div id="detalleTarifa">-</div>
      </div>
    </div>
    <div style="margin-top:.8rem" id="detalleTotal"><strong>Total:</strong> -</div>
  </div>

  <div id="noResult" class="small-muted center" style="margin-top:1rem; display:none;">Aquí se mostrará el estado del envío.</div>
</section>

<!-- PACKAGE DETAIL MODAL (lightbox) - solo CERRAR -->
<div id="packageBackdrop" class="modal-backdrop package-modal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pkgTitle">
    <button class="close-x" id="pkgClose" aria-label="Cerrar">&times;</button>
    <h3 id="pkgTitle">Pedido</h3>

    <div style="margin-top:8px;">
      <div style="margin:8px 0;"><strong>Nombre:</strong> <span id="pkgNombre">-</span></div>
      <div style="margin:8px 0;"><strong>Teléfono:</strong> <a id="pkgTelefono" class="pedido-phone" target="_blank" rel="noopener">-</a></div>
      <div style="margin:8px 0;"><strong>Código seguimiento:</strong> <span id="pkgCodigo">-</span></div>
      <div style="margin:8px 0;"><strong>Tipo:</strong> <span id="pkgTipo">-</span></div>
      <div style="margin:8px 0;"><strong>Peso:</strong> <span id="pkgPeso">-</span></div>
      <div style="margin:8px 0;"><strong>Tarifa / lb:</strong> <span id="pkgTarifa">-</span></div>
      <div style="margin:8px 0;"><strong>Total:</strong> <span id="pkgTotal">-</span></div>
    </div>

    <hr style="margin:12px 0;opacity:.06"/>

    <div id="pkgTimeline" class="timeline"></div>

    <div style="margin-top:12px;display:flex;gap:8px;">
      <!-- solo cerrar -->
      <button id="btnClosePkg" class="calc-btn" style="flex:1;background:#888">Cerrar</button>
    </div>
  </div>
</div>

<!-- waiting & confirm modals (demo) -->
<div id="waitingBackdrop" class="modal-backdrop" aria-hidden="true" style="z-index:3500;">
  <div class="modal" role="status" aria-live="polite">
    <div style="width:72px;height:72px;border-radius:999px;margin:0 auto 8px;display:flex;align-items:center;justify-content:center;background:rgba(47,82,143,0.06);">
      <div style="width:36px;height:36px;border-radius:50%;border:4px solid rgba(47,82,143,0.18);border-top-color:var(--color-accent);animation:spin 1s linear infinite;"></div>
    </div>
    <h3 style="color:var(--color-accent);margin-bottom:6px;">Realizando acción</h3>
    <p style="color:#444;margin-bottom:8px;">Simulando operación, espera...</p>
  </div>
</div>

<div id="confirmBackdrop" class="modal-backdrop" aria-hidden="true" style="z-index:3600;">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div style="width:72px;height:72px;margin:0 auto 8px;display:flex;align-items:center;justify-content:center;" class="check-icon">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M9 12.5l2 2 4-4" stroke="#2F528F" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
      </svg>
    </div>
    <h3 id="modalTitle" style="margin-bottom:.4rem;color:var(--color-accent)">¡Hecho!</h3>
    <p class="receipt-small">Operación simulada completada. (Demo)</p>
    <div style="margin-top:1rem;">
      <button id="confirmClose" class="calc-btn" style="background:var(--solicitar-highlight)">Cerrar</button>
    </div>
  </div>
</div>

<!-- confetti wrapper -->
<div id="confettiWrap" aria-hidden="true"></div>

<footer>
  <p>&copy; 2025. Irvin Prado. Ascende Superius - Seek Higher Things</p>
</footer>

<script>
/* DEMO — NO HAY LLAMADAS REALES (todo local) */

/* NAV */
const btnInicio = document.getElementById('btnInicio');
const btnCotizar = document.getElementById('btnCotizar');
const btnSeguimiento = document.getElementById('btnSeguimiento');
const secciones = {
  inicio: document.getElementById('inicio'),
  cotizar: document.getElementById('cotizar'),
  solicitar: document.getElementById('solicitar'),
  seguimiento: document.getElementById('seguimiento')
};
function mostrarSeccion(nombre){
  for(let s in secciones) secciones[s].classList.remove('active');
  if(secciones[nombre]) secciones[nombre].classList.add('active');
  [btnInicio, btnCotizar, btnSeguimiento].forEach(b => b.classList.add('inactive'));
  if(nombre==='inicio') btnInicio.classList.remove('inactive');
  if(nombre==='cotizar') btnCotizar.classList.remove('inactive');
  if(nombre==='seguimiento') btnSeguimiento.classList.remove('inactive');
}
btnInicio.addEventListener('click',()=>mostrarSeccion('inicio'));
btnCotizar.addEventListener('click',()=>mostrarSeccion('cotizar'));
btnSeguimiento.addEventListener('click',()=>mostrarSeccion('seguimiento'));

/* COTIZAR: muestra resultado en mini contenedor centrado */
function calcularCotizar(){
  const tipo = document.getElementById('tipoEnvioCotizar').value;
  const peso = parseFloat(document.getElementById('pesoCotizar').value);
  const resultadoBox = document.getElementById('resultadoCotizar');
  const priceEl = document.getElementById('cotizaPrice');
  const daysEl = document.getElementById('cotizaDays');
  if(isNaN(peso)||peso<=0){ priceEl.textContent='Por favor, ingresa un peso válido.'; resultadoBox.style.display='flex'; daysEl.textContent=''; return; }
  let precio=0,dias=0;
  if(tipo==='aereo'){ precio = peso*7.50; dias=7; } else { precio = peso*3.00; dias=15; }
  priceEl.textContent = `$${precio.toFixed(2)} USD`;
  daysEl.textContent = `Llegada estimada: ${dias} días`;
  resultadoBox.style.display='flex';
  // show CTA after 3s (demo)
  setTimeout(()=>{ const cta = document.getElementById('floatCTA'); if(cta) cta.style.display='block'; }, 3000);
}

/* SOLICITAR (demo behavior only) */
const btnCalcularSolicitar = document.getElementById('btnCalcularSolicitar');
const reciboDiv = document.getElementById('reciboSolicitar');
const precioPorLbEl = document.getElementById('precioPorLb');
const librasTotalesEl = document.getElementById('librasTotales');
const totalSolicitarEl = document.getElementById('totalSolicitar');
const btnConfirmarSolicitud = document.getElementById('btnConfirmarSolicitud');

btnCalcularSolicitar.addEventListener('click', onCalcularSolicitar);
function onCalcularSolicitar(){
  const nombre = (document.getElementById('nombreSolicitar').value||'').trim();
  const telCode = document.getElementById('telCodeSolicitar').value;
  const telefonoDigits = (document.getElementById('telefonoSolicitar').value||'').trim();
  const plataforma = (document.getElementById('plataformaSolicitar').value||'').trim();
  const tipo = document.getElementById('tipoEnvioSolicitar').value;
  const peso = parseFloat(document.getElementById('pesoSolicitar').value);
  if(!nombre){ alert('Por favor ingresa tu nombre.'); return; }
  if(!telefonoDigits || !/^\d{8,10}$/.test(telefonoDigits)){ alert('Ingresa un número válido de 8 a 10 dígitos.'); return; }
  if(!plataforma){ alert('Por favor indica la plataforma o agencia de donde viene el paquete.'); return; }
  if(!tipo){ alert('Selecciona el tipo de envío.'); return; }
  if(isNaN(peso) || peso<=0){ alert('Ingresa un peso válido mayor que 0.'); return; }
  const pricePerLb = (tipo === 'aereo') ? 7.50 : 3.00;
  const total = Number((pricePerLb * peso).toFixed(2));
  precioPorLbEl.textContent = `$${pricePerLb.toFixed(2)} USD`;
  librasTotalesEl.textContent = `${peso} lb`;
  totalSolicitarEl.textContent = `$${total.toFixed(2)} USD`;
  reciboDiv.style.display = 'block';
  btnCalcularSolicitar.style.display = 'none';
  btnConfirmarSolicitud.style.display = 'block';
  btnConfirmarSolicitud.dataset.payload = JSON.stringify({nombre, telefono:telCode+telefonoDigits, plataforma, tipo, peso, pricePerLb, total});
}

const waitingBackdrop = document.getElementById('waitingBackdrop');
const confirmBackdrop = document.getElementById('confirmBackdrop');
const confirmCloseBtn = document.getElementById('confirmClose');

btnConfirmarSolicitud.addEventListener('click', ()=>{
  showWaiting();
  setTimeout(()=>{ hideWaiting(); showConfirm(); }, 900);
});
confirmCloseBtn.addEventListener('click', ()=>{
  hideConfirm();
  // reset form visually
  document.getElementById('nombreSolicitar').value = '';
  document.getElementById('telCodeSolicitar').value = '+505';
  document.getElementById('telefonoSolicitar').value = '';
  document.getElementById('plataformaSolicitar').value = '';
  document.getElementById('descripcionSolicitar').value = '';
  document.getElementById('tipoEnvioSolicitar').value = '';
  document.getElementById('pesoSolicitar').value = '';
  reciboDiv.style.display = 'none';
  btnConfirmarSolicitud.style.display = 'none';
  btnCalcularSolicitar.style.display = 'block';
});

function showWaiting(){ waitingBackdrop.classList.add('show'); waitingBackdrop.setAttribute('aria-hidden','false'); }
function hideWaiting(){ waitingBackdrop.classList.remove('show'); waitingBackdrop.setAttribute('aria-hidden','true'); }
function showConfirm(){ confirmBackdrop.classList.add('show'); confirmBackdrop.setAttribute('aria-hidden','false'); }
function hideConfirm(){ confirmBackdrop.classList.remove('show'); confirmBackdrop.setAttribute('aria-hidden','true'); }

/* SEGUIMIENTO (demo) */
const btnBuscar = document.getElementById('btnBuscar');
const btnLimpiar = document.getElementById('btnLimpiar');
const overlay = document.getElementById('searchOverlay');
const resultsList = document.getElementById('resultsList');
const noResult = document.getElementById('noResult');

btnBuscar.addEventListener('click', onBuscar);
btnLimpiar.addEventListener('click', onLimpiar);

function onLimpiar(){
  document.getElementById('codigo').value='';
  document.getElementById('nombreBuscar').value='';
  document.getElementById('telefonoBuscar').value='';
  document.getElementById('telCodeBuscar').value='+505';
  resultsList.style.display='none';
  resultsList.innerHTML='';
  hideResultArea();
}

function hideResultArea(){
  document.getElementById('resultContainer').style.display='none';
  noResult.style.display='block';
  noResult.textContent = 'Aquí se mostrará el estado del envío.';
  const t = document.getElementById('timeline'); if(t) t.innerHTML='';
}

/* gather params */
function gatherSearchParams(){
  const codigo = (document.getElementById('codigo').value||'').trim() || null;
  const nombre = (document.getElementById('nombreBuscar').value||'').trim() || null;
  const country = document.getElementById('telCodeBuscar').value;
  const telefonoDigits = (document.getElementById('telefonoBuscar').value||'').trim() || null;
  const telefono = telefonoDigits ? `${country}${telefonoDigits}` : null;
  return { codigo, nombre, telefono };
}

/* validate */
function validateAtLeastOne(params){
  return Boolean(params.codigo || params.nombre || params.telefono);
}

/* main */
async function onBuscar(){
  const params = gatherSearchParams();
  if(!validateAtLeastOne(params)){
    alert('Ingresa al menos el código, o el nombre, o el teléfono para buscar.');
    return;
  }
  overlay.style.display = 'block';
  resultsList.style.display='none';
  resultsList.innerHTML='';
  hideResultArea();
  const pkgs = await fetchPackageFromAPI(params);
  overlay.style.display = 'none';
  if(!pkgs || pkgs.length === 0){
    noResult.style.display = 'block';
    noResult.textContent = 'No se encontró paquete con los criterios introducidos.';
    return;
  }
  // if search by code (single) show only that entry as single-card (but still use list)
  renderResultsList(pkgs.slice(0,3));
}

/* DEMO: returns array of up to 3 fake packages
   - If codigo exact matches '1989-A'/'1989-B'/'1989-C' -> return that single package
   - If codigo === '1989' or 'demo' -> return first package only (simulate single-code search)
   - If nombre or telefono match demo triggers -> return up to 3 packages
*/
async function fetchPackageFromAPI({codigo, nombre, telefono}){
  const phoneDigits = (telefono||'').replace(/\D/g,'');
  const demoPhoneMatch = phoneDigits === '50512345678' || phoneDigits === '12345678';
  const demoName = (nombre && nombre.trim()==='Lester Gamez');
  const demoCode = codigo ? codigo.toString().trim() : null;

  await delay(600);

  // base date
  const baseDate = new Date('2025-08-10');
  function fmt(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }

  const all = [
    {
      paquete: { id:1, nombre_cliente:'Lester Gamez', codigo_seguimiento:'1989-A', tipo_envio_id:1, peso_libras:5.5, tarifa_usd:4.25, fecha_estado: fmt(new Date(baseDate.getTime())), telefono:'+50512345678' },
      historial: { estado1:'recibido', fecha1: fmt(new Date(baseDate.getTime())), estado2:'en_transito', fecha2: fmt(new Date(baseDate.getTime()+2*24*3600*1000)), estado3:'en_aduana', fecha3: fmt(new Date(baseDate.getTime()+6*24*3600*1000)), estado4:'listo_recoger', fecha4: fmt(new Date(baseDate.getTime()+8*24*3600*1000)) }
    },
    {
      paquete: { id:2, nombre_cliente:'Lester Gamez', codigo_seguimiento:'1989-B', tipo_envio_id:2, peso_libras:3.2, tarifa_usd:3.10, fecha_estado: fmt(new Date(baseDate.getTime()+1*24*3600*1000)), telefono:'+50512345678' },
      historial: { estado1:'recibido', fecha1: fmt(new Date(baseDate.getTime()+1*24*3600*1000)), estado2:'en_transito', fecha2: fmt(new Date(baseDate.getTime()+3*24*3600*1000)), estado3:null, fecha3:null, estado4:null, fecha4:null }
    },
    {
      paquete: { id:3, nombre_cliente:'Lester Gamez', codigo_seguimiento:'1989-C', tipo_envio_id:1, peso_libras:null, tarifa_usd:null, fecha_estado: fmt(new Date(baseDate.getTime()+2*24*3600*1000)), telefono:'+50512345678' },
      historial: { estado1:'recibido', fecha1: fmt(new Date(baseDate.getTime()+2*24*3600*1000)), estado2:null, fecha2:null, estado3:null, fecha3:null, estado4:null, fecha4:null }
    }
  ];

  // exact code checks
  if (demoCode) {
    const c = demoCode.toString().toLowerCase();
    // direct exact match
    const foundExact = all.find(a => (a.paquete.codigo_seguimiento || '').toLowerCase() === c);
    if (foundExact) return [foundExact];
    // if user typed '1989' or 'demo' treat as single-code search -> return first
    if (c === '1989' || c === 'demo') return [all[0]];
    // otherwise no result
    return null;
  }

  // name or phone demo triggers -> return up to 3
  if (demoName || demoPhoneMatch) return all;

  // default none
  return null;
}

/* helper delay */
function delay(ms){ return new Promise(resolve => setTimeout(resolve, ms)); }

/* Render list of result cards (up to 3) */
function renderResultsList(pkgs){
  resultsList.innerHTML = '';
  pkgs.forEach((item, idx) => {
    const p = item.paquete;
    const h = item.historial || {};
    // find first non-null fecha (fecha1..fecha4) or use fecha_estado
    let firstDate = p.fecha_estado || null;
    for(let i=1;i<=4;i++){
      const f = h[`fecha${i}`];
      if(f){ firstDate = f; break; }
    }
    const tipo = (p.tipo_envio_id===1)?'Aéreo': (p.tipo_envio_id===2)?'Marítimo':'-';
    const card = document.createElement('div');
    card.className = 'result-card';
    card.dataset.index = idx;
    card.innerHTML = `<div class="left"><div class="result-title"><strong>${escapeHtml(p.nombre_cliente||'Sin nombre')}</strong></div><div class="meta">${firstDate?formatDate(firstDate):'Fecha no disponible'}</div></div><div class="right">${escapeHtml(tipo)}</div>`;
    card.addEventListener('click', ()=> openPackageDetail(item));
    resultsList.appendChild(card);
  });
  resultsList.style.display = 'block';
  noResult.style.display='none';
}

/* Package modal logic (solo detalle + cerrar) */
const packageBackdrop = document.getElementById('packageBackdrop');
const pkgClose = document.getElementById('pkgClose');
const btnClosePkg = document.getElementById('btnClosePkg');

function openPackageDetail(item){
  const p = item.paquete;
  const h = item.historial || {};
  document.getElementById('pkgNombre').textContent = p.nombre_cliente || '-';
  document.getElementById('pkgTelefono').textContent = p.telefono || '-';
  if(p.telefono){ const digits = (p.telefono||'').replace(/\D/g,''); document.getElementById('pkgTelefono').href = `https://wa.me/${digits}`; } else { document.getElementById('pkgTelefono').removeAttribute('href'); }
  document.getElementById('pkgCodigo').textContent = p.codigo_seguimiento || '-';
  document.getElementById('pkgTipo').textContent = (p.tipo_envio_id===1)?'Aéreo':(p.tipo_envio_id===2)?'Marítimo':'-';
  document.getElementById('pkgPeso').textContent = p.peso_libras!=null ? `${p.peso_libras} lb` : 'No disponible, actualizar los datos';
  document.getElementById('pkgTarifa').textContent = p.tarifa_usd!=null ? `$${Number(p.tarifa_usd).toFixed(2)} USD` : 'No disponible, actualizar los datos';
  if(p.peso_libras!=null && p.tarifa_usd!=null){ const tot = Number(p.peso_libras)*Number(p.tarifa_usd); document.getElementById('pkgTotal').textContent = `$${isFinite(tot)?tot.toFixed(2):'0.00'} USD`; } else { document.getElementById('pkgTotal').textContent = 'No disponible'; }

  // timeline
  const timelineWrap = document.getElementById('pkgTimeline');
  timelineWrap.innerHTML = '';
  const items = [];
  for(let i=1;i<=4;i++){
    const s = h[`estado${i}`];
    const f = h[`fecha${i}`];
    if((s && String(s).trim()!=='') || (f && String(f).trim()!=='')) items.push({estado:s || null, fecha:f || null});
  }
  if(items.length===0){
    timelineWrap.innerHTML = '<div class="small-muted">Historial no disponible</div>';
  } else {
    items.forEach(it => {
      const div = document.createElement('div');
      div.className = 'timeline-item';
      const label = mapStateLabel(it.estado);
      div.innerHTML = `<div class="state">${label}</div><div class="subtext">${mapStateSubtext(it.estado)||''}</div><div class="fecha">${it.fecha?('El '+formatDate(it.fecha)):''}</div>`;
      if(it.estado==='listo_recoger'){ div.classList.add('blink'); triggerConfetti(); }
      timelineWrap.appendChild(div);
    });
  }

  // show modal
  packageBackdrop.classList.add('show');
  packageBackdrop.setAttribute('aria-hidden','false');
}
function closePackageModal(){ packageBackdrop.classList.remove('show'); packageBackdrop.setAttribute('aria-hidden','true'); }
pkgClose.addEventListener('click', closePackageModal);
btnClosePkg.addEventListener('click', closePackageModal);
packageBackdrop.addEventListener('click', (e)=>{ if(e.target===packageBackdrop) { /* do nothing (no close on backdrop) */ } });

/* helpers */
function mapStateLabel(raw){
  if(!raw) return 'Estado desconocido';
  const r = raw.toString().toLowerCase();
  switch(r){
    case 'recibido': return 'Recibido';
    case 'en_transito': return 'En tránsito';
    case 'en_aduana': return 'En aduana';
    case 'listo_recoger': return 'Listo Para Recoger';
    default: return capitalize(r.replace(/_/g,' '));
  }
}
function mapStateSubtext(raw){
  if(!raw) return '';
  const r = raw.toString().toLowerCase();
  switch(r){
    case 'recibido': return 'Paquete recibido por Nica Express Way en Estados Unidos';
    case 'en_transito': return 'Paquete en camino a Nicaragua';
    case 'en_aduana': return 'Paquete en aduanas, será recibido por la agencia pronto';
    case 'listo_recoger': return 'Paquete listo para retirar!';
    default: return '';
  }
}
function formatDate(d){
  try {
    const dt = new Date(d);
    if (isNaN(dt)) {
      if(typeof d==='string' && d.includes('-')){
        const [y,m,day] = d.split('-');
        return `${day}/${m}/${y}`;
      }
      return d;
    }
    return dt.toLocaleDateString('es-ES');
  } catch(e){ return d; }
}
function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
function escapeHtml(str){ if (str===null||str===undefined) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* CONFETTI (conservador) */
let confettiTimeout = null;
function triggerConfettiDesktop(){
  const wrap = document.getElementById('confettiWrap');
  if (!wrap) return;
  const N = 400;
  const colors = ['#1f3a66','#2F528F','#79A7E4'];
  for (let i=0; i<N; i++){
    const el = document.createElement('div');
    const size = Math.floor(Math.random()*8)+6;
    el.style.position='absolute';
    el.style.left = (Math.random()*100)+'%';
    el.style.top = (-50 + Math.random()*-50) + 'px';
    el.style.width = size+'px';
    el.style.height = (size*0.6)+'px';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.opacity = String(0.7 + Math.random()*0.3);
    el.style.borderRadius='2px';
    el.style.zIndex = 2500;
    const destX = (Math.random()*500 - 250);
    const destY = window.innerHeight + 100;
    const duration = 4 + Math.random()*4;
    el.style.transition = `transform ${duration}s ease-out, top ${duration}s linear, opacity ${duration}s linear`;
    wrap.appendChild(el);
    requestAnimationFrame(()=>{
      el.style.top = destY + 'px';
      el.style.transform = `translateX(${destX}px) rotate(${Math.random()*360}deg)`;
      el.style.opacity = '0';
    });
  }
  if (confettiTimeout) clearTimeout(confettiTimeout);
  confettiTimeout = setTimeout(()=>{ wrap.innerHTML=''; }, 9000);
}
function triggerConfettiMobile(){
  const wrap = document.getElementById('confettiWrap');
  if (!wrap) return;
  const N = 100;
  const colors = ['#1f3a66','#2F528F','#79A7E4'];
  for (let i=0; i<N; i++){
    const el = document.createElement('div');
    const size = Math.floor(Math.random()*8)+6;
    el.style.position='absolute';
    el.style.left = (Math.random()*100)+'%';
    el.style.top = (-50 + Math.random()*-50) + 'px';
    el.style.width = size+'px';
    el.style.height = (size*0.6)+'px';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.opacity = String(0.7 + Math.random()*0.3);
    el.style.borderRadius='2px';
    el.style.zIndex = 2500;
    const destX = (Math.random()*500 - 250);
    const destY = window.innerHeight + 100;
    const duration = 4 + Math.random()*4;
    el.style.transition = `transform ${duration}s ease-out, top ${duration}s linear, opacity ${duration}s linear`;
    wrap.appendChild(el);
    requestAnimationFrame(()=>{
      el.style.top = destY + 'px';
      el.style.transform = `translateX(${destX}px) rotate(${Math.random()*360}deg)`;
      el.style.opacity = '0';
    });
  }
  if (confettiTimeout) clearTimeout(confettiTimeout);
  confettiTimeout = setTimeout(()=>{ wrap.innerHTML=''; }, 9000);
}
function triggerConfetti(){ if(window.innerWidth<=420) triggerConfettiMobile(); else triggerConfettiDesktop(); }

/* Enter shortcuts */
['codigo','telefonoBuscar','nombreBuscar','pesoCotizar'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); if(id==='pesoCotizar') calcularCotizar(); else onBuscar(); } });
});

/* initial state */
hideResultArea();
</script>
</body>
</html>
